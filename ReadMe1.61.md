# 道の駅Webスタンプ帳 ReadMe (Ver1.61)

## 概要

「道の駅Webスタンプ帳」は、日本の道の駅巡りを記録し、効率的なルート計画を支援するためのWebアプリケーションです。CSV形式の道の駅データを読み込んで管理し、地図上に道の駅マーカーを表示します。また、出発地点、中継地点、終了地点を設定して最適なルートを計算し、その情報を一覧表示・印刷・CSV保存することができます。

## 主な機能

*   **道の駅データ管理:**
    *   道の駅データをCSVファイルから読み込み、管理できます。
    *   読み込んだ道の駅の訪問日、名称、電話番号、住所、緯度、経度、URL、メモを閲覧・編集できます。
    *   編集内容はCSVファイルとして保存（ダウンロード）できます。
    *   訪問日が入力された道の駅の数と達成率をリアルタイムで表示します。
*   **地図表示機能:**
    *   読み込んだ道の駅を地図上にマーカーで表示します。
    *   訪問済みの道の駅は赤色のマーカー、未訪問の道の駅は標準の青色マーカーで区別されます。
    *   **道の駅マーカーの表示・非表示切り替え機能。**
    *   **マーカー非表示状態でも、道の駅プルダウンで選択した道の駅のマーカーのみを一時的に表示する機能。**
*   **ルート作成機能:**
    *   地図上の任意の場所、または道の駅マーカーをクリックして、出発地点、中継地点、終了地点を設定できます。
    *   設定された地点にはそれぞれ専用のマーカー（出発：緑、中継：青、経由：紫、終了：赤）が表示されます。
    *   中継地点と経由地を区別し、中継地点には滞在時間を考慮した計算が可能です。
    *   走行時速と地点ごとの滞在時間（中継地点のみ）を設定し、ルートの総走行時間、総滞在時間、総経過時間を計算します。
    *   設定したルート上の地点を個別に、または一括で解除できます。
    *   **ルートCSVファイルを読み込むことで、以前に保存したルートを復元できます。**
    *   **ルートCSV読み込み時には、地図上の道の駅マーカーを自動的に非表示にします。**
    *   **ルートをクリアすると、道の駅CSVが読み込まれていれば道の駅マーカーを自動的に再表示します。**
*   **ルート情報出力:**
    *   計算されたルートの地点リスト、総距離、時間情報を別ウィンドウで表示できます。
    *   表示されたルート一覧を印刷できます。
    *   現在のルート情報をCSVファイルとして保存できます。
*   **取扱説明書:** アプリケーションの操作方法とCSVフォーマットに関する詳細な説明を別ウィンドウで参照できます。

## 使い方

1.  **アプリケーションの起動:** `index.html` ファイルをウェブブラウザで開いてください。
2.  **道の駅CSVの読み込み:**
    *   「道の駅情報」タブが選択されていることを確認します。
    *   「道の駅CSVを選択」ボタンをクリックし、道の駅データを含むCSVファイルを選択します。
    *   読み込みが成功すると、道の駅がプルダウンメニューに表示され、地図上にマーカーが追加されます。
    *   **道の駅マーカーの表示/非表示:** 「道の駅を選択」プルダウンの下にある「道の駅マーカーを非表示/表示」ボタンで、地図上の道の駅マーカーの表示を切り替えられます。非表示状態でも、プルダウンで道の駅を選択すると、その道の駅のマーカーのみ一時的に表示されます。
3.  **道の駅情報の閲覧と編集:**
    *   「道の駅を選択」プルダウンから道の駅を選ぶと、その詳細情報が下に表示され、地図がその地点に移動します。
    *   詳細表示の下にある「編集」ボタンをクリックすると、訪問日やメモなどの情報を編集できます。
    *   編集後、「保存」または「キャンセル」で変更を確定または破棄します。
    *   変更を保存すると、「編集内容をCSVで保存」ボタンから更新された道の駅CSVをダウンロードできます。
4.  **ルートの作成:**
    *   「ルート作成」タブに切り替えます。
    *   **出発地点の設定:** 「出発地点に設定」ボタンをクリックし、地図上の任意の場所か道の駅マーカーをクリックして設定します。
    *   **終了地点の設定:** 「終了地点に設定」ボタンをクリックし、地図上の任意の場所か道の駅マーカーをクリックして設定します。
    *   **中継地点/経由地の追加:**
        *   「経由地として地図で選択」ボタンをクリックし、地図上の任意の場所をクリックして経由地（滞在時間なし、紫色マーカー）を追加します。
        *   「道の駅情報」タブで道の駅を選択し、「選択中の道の駅を中継地点に追加」ボタンをクリックして中継地点（滞在時間あり、青色マーカー）を追加することもできます。
    *   **地点の解除:**
        *   地図上の各地点マーカーを再度クリックすると、その地点をルートから削除できます。
        *   各地点設定ボタンの横にある「解除」ボタンや「全解除」ボタンで一括解除も可能です。
        *   「現在の中継地点/経由地」リストの「削除」ボタンでも個別に解除できます。
    *   **走行時速と滞在時間の設定:** 「走行時速(km/h)」と「滞在時間(分/中継点)」の入力欄で、ルート計算に使用される値を調整します。
    *   **ルートCSVの読み込み/保存:** 「ルートCSVを読込」で以前保存したルートを復元できます。この際、道の駅マーカーは非表示になります。「ルートをCSVで保存」で現在のルートを保存できます。
    *   **ルートのクリア:** 「ルートをクリア」ボタンで全てのルート情報を解除します。道の駅CSVが読み込まれていれば、道の駅マーカーは自動的に再表示されます。
5.  **ルート一覧の表示と印刷:**
    *   出発地点と終了地点が設定されている状態で、「ルート一覧を表示 (別ウィンドウ)」ボタンをクリックすると、ルート詳細と計算結果が新しいウィンドウで表示されます。
    *   そのウィンドウで「印刷」ボタンをクリックすると、印刷できます。
6.  **取扱説明書:** 「取扱説明書」ボタンをクリックすると、このReadMeの詳細版が新しいウィンドウで開きます。

## CSVファイルフォーマット

### 4.1. 道の駅CSVフォーマット

以下の8つの項目をカンマ区切りで記述してください。1行目はヘッダー行として扱われます。

```csv
訪問日,名称,電話番号,住所,緯度,経度,URL,メモ
```

*   **訪問日:** YYYY-MM-DD形式。未訪問の場合は空欄。
*   **名称:** 道の駅の名称。
*   **電話番号:** 電話番号。
*   **住所:** 住所。
*   **緯度:** 緯度（数値）。
*   **経度:** 経度（数値）。
*   **URL:** 公式サイトなどのURL。
*   **メモ:** 道の駅に関する自由なメモ。

**注意:** フィールド内にカンマ (`,`) や改行 (`\n`)、二重引用符 (`"`) が含まれる場合は、そのフィールド全体を二重引用符で囲み、内部の二重引用符は二重にエスケープ (`""`) してください。

### 4.2. ルートCSVフォーマット

「ルートをCSVで保存」で出力されるCSVのフォーマットは、大きく2つのセクションに分かれています。

```csv
区分,道の駅名/地点名,電話番号,緯度,経度,滞在時間考慮
出発地点 (1),"道の駅○○","0123-45-6789",35.xxxx,139.yyyy,N/A
中継地点 (2),"道の駅△△","0987-65-4321",36.xxxx,138.yyyy,true
経由地 (3),"地図上の経由地 (Lat: 37.aaaa, Lng: 137.bbbb)","",37.aaaa,137.bbbb,false
終了地点 (4),"地図上の終了地点 (Lat: 38.cccc, Lng: 136.dddd)","",38.cccc,136.dddd,N/A

ルート情報:
設定した走行時速(km/h),40
設定した地点ごとの滞在時間(分),30
ルート総移動距離(km),123.4
総走行時間,3時間5分
総滞在時間 (中継地点のみ),1時間30分
総経過時間,4時間35分
```

*   **地点情報セクション:** 各地点の区分、名前、電話番号、緯度、経度、滞在時間考慮フラグが記述されます。出発/終了地点の滞在時間考慮フラグは「N/A」となります。区分が「中継地点」の場合は滞在時間が考慮され、「経由地」の場合は考慮されません。
*   **ルート情報セクション:** `ルート情報:` の行以降に、設定した走行時速、滞在時間、計算された総距離や時間が記述されます。このセクションは、ルートCSV読込時に設定値の復元に使用されます。

## 依存ライブラリ

*   **Leaflet:** 地図表示ライブラリ
*   **Leaflet Routing Machine:** ルーティング機能（OpenStreetMapのOSRMサービスを利用）

## その他の注意事項

*   地図データの表示にはOpenStreetMap、ルーティングにはOSRMのデモサーバーを利用しています。OSRMデモサーバーは本番環境での利用には適していません。
*   ブラウザのポップアップブロック設定によっては、ルート一覧や取扱説明書が新しいウィンドウで開かない場合があります。その際はブラウザの設定をご確認ください。

---
**バージョン 1.61**

*   道の駅マーカーの表示・非表示ボタンを追加。
*   道の駅マーカー非表示時でも、選択された道の駅のマーカーのみを一時的に表示する機能を追加。
*   ルートCSV読み込み時に道の駅マーカーを自動非表示にする機能を追加。
*   ルートクリア時に道の駅マーカーを自動再表示する機能を追加。
*   取扱説明書 (Ver1.50表記) を Ver1.61の機能に合わせて更新。

---